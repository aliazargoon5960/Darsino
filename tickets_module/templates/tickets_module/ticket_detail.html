{% extends 'user_panel_base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block page_title %}

صفحه جزییات تیکت

{% endblock page_title %}

{% block content %}

<div class="container" style="margin-top: 60px; padding-top: 40px;">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <!-- هدر صفحه -->
            <div class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h4 class="fw-bold text-primary mt-3">
                        <i class="bi bi-ticket-detailed me-2"></i>جزئیات تیکت
                    </h4>
                </div>
                <div class="text-end">
                    <span class="badge {% if ticket.status == 'open' %}bg-warning text-dark{% elif ticket.status == 'pending' %}bg-info{% elif ticket.status == 'answered' %}bg-success{% else %}bg-secondary{% endif %} px-4 py-2 fs-6 mb-2">
                        وضعیت: {{ ticket.get_status_display }}
                    </span><br>
                    <span class="badge {% if ticket.priority == 'low' %}bg-success{% elif ticket.priority == 'normal' %}bg-primary{% elif ticket.priority == 'high' %}bg-warning text-dark{% else %}bg-danger{% endif %} px-4 py-2 fs-6 mt-2">
                        اولویت: {{ ticket.get_priority_display }}
                    </span>
                </div>
            </div>

            <!-- تیکت اصلی -->
            <div class="card shadow border-0 mb-5" style="border-radius: 18px;">
                <div class="card-header py-4" style="background: linear-gradient(135deg, #1e88e5, #1565c0); color: white;">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-chat-dots me-2"></i>{{ ticket.subject }}
                    </h5>
                    <small class="d-block mt-2">ارسال شده در {{ ticket.created_at|date:"Y/m/d - H:i" }}</small>
                </div>
                <div class="card-body p-5">
                    <div class="d-flex align-items-start">
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-4">
                            <i class="bi bi-person-circle text-primary fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="fw-bold text-dark mb-3">{{ ticket.user.get_full_name|default:ticket.user.username }}</h6>
                            <p class="text-muted mb-3" style="line-height: 1.8; font-size: 16px;">
                                {{ ticket.message }}
                            </p>

                            {% if ticket_attachments %}
                                <div class="mt-3">
                                    <h6 class="fw-bold text-dark mb-2">فایل‌های تیکت:</h6>
                                    <div class="d-flex flex-wrap gap-3">
                                        {% for attach in ticket_attachments %}
                                            {% with attach.file.url as file_url %}
                                                {% if file_url %}
                                                    {% with file_url|lower as file_url_lower %}
                                                        {% if file_url_lower|slice:"-4:" == ".png" or file_url_lower|slice:"-4:" == ".jpg" or file_url_lower|slice:"-5:" == ".jpeg" %}
                                                            <a href="{{ file_url }}" target="_blank" class="attachment-link border rounded p-2 shadow-sm me-2 mb-2 d-inline-block">
                                                                <img src="{{ file_url }}" alt="attachment" style="max-width:200px; border-radius:8px; margin:5px 0;">
                                                            </a>
                                                        {% else %}
                                                            <a href="{{ file_url }}" download class="attachment-link border rounded p-2 shadow-sm text-blue-500 underline me-2 mb-2 d-inline-block">
                                                                دانلود فایل
                                                            </a>
                                                        {% endif %}
                                                    {% endwith %}
                                                {% endif %}
                                            {% endwith %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- پاسخ‌ها -->
            <div class="mb-5">
                <h5 class="fw-bold text-dark mb-4">
                    <i class="bi bi-reply-all me-2 text-primary"></i>پاسخ‌ها
                    <span class="badge bg-primary rounded-pill ms-2">{{ ticket.replies.count }}</span>
                </h5>

                {% for reply in ticket.replies.all %}
                <div class="card shadow-sm border-0 mb-4" style="border-radius: 16px;">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-start">
                            <div class="{% if reply.user.is_staff %}bg-danger bg-opacity-10{% else %}bg-success bg-opacity-10{% endif %} p-3 rounded-circle me-4">
                                <i class="bi {% if reply.user.is_staff %}bi-shield-check{% else %}bi-person{% endif %} {% if reply.user.is_staff %}text-danger{% else %}text-success{% endif %} fs-4"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold {% if reply.user.is_staff %}text-danger{% else %}text-success{% endif %} mb-0">
                                        {{ reply.user.get_full_name|default:reply.user.username }}
                                    </h6>
                                    <small class="text-muted">{{ reply.created_at|date:"Y/m/d - H:i" }}</small>
                                </div>
                                <p class="text-dark mb-3" style="line-height: 1.8; font-size: 16px;">
                                    {{ reply.message }}
                                </p>

                                {% if reply.attachments.exists %}
                                <div class="mt-2">
                                    <h6 class="fw-bold text-dark mb-1">فایل‌های پاسخ:</h6>
                                    <div class="d-flex flex-wrap gap-3">
                                        {% for attach in reply.attachments.all %}
                                            {% with attach.file.url as file_url %}
                                                {% if file_url %}
                                                    {% with file_url|lower as file_url_lower %}
                                                        {% if file_url_lower|slice:"-4:" == ".png" or file_url_lower|slice:"-4:" == ".jpg" or file_url_lower|slice:"-5:" == ".jpeg" %}
                                                            <a href="{{ file_url }}" target="_blank" class="attachment-link border rounded p-2 shadow-sm me-2 mb-2 d-inline-block">
                                                                <img src="{{ file_url }}" alt="reply image" style="width:120px; height:120px; object-fit:cover; border-radius: 8px;">
                                                            </a>
                                                        {% else %}
                                                            <a href="{{ file_url }}" download class="attachment-link border rounded p-2 shadow-sm me-2 mb-2 d-inline-block">
                                                                <i class="bi bi-paperclip me-1"></i>{{ attach.file.name|cut:"tickets/attachments/" }}
                                                            </a>
                                                        {% endif %}
                                                    {% endwith %}
                                                {% endif %}
                                            {% endwith %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5">
                    <i class="bi bi-chat-dots display-4 text-muted mb-3"></i>
                    <p class="text-muted mt-3 fs-5">هنوز پاسخی ثبت نشده است</p>
                </div>
                {% endfor %}
            </div>

            <!-- فرم ارسال پاسخ -->
            <div class="card shadow border-0" style="border-radius: 18px;">
                <div class="card-header py-4" style="background: linear-gradient(135deg, #1e88e5, #1565c0); color: white;">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-reply me-2"></i>ارسال پاسخ جدید</h5>
                </div>
                <div class="card-body p-5">
                    <form method="post" action="{% url 'tickets_module:ticket_reply' ticket.pk %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label class="form-label fw-bold text-dark mb-3"><i class="bi bi-chat-text me-2 text-primary"></i>متن پاسخ</label>
                            <textarea name="message" class="form-control" rows="6" placeholder="متن پاسخ خود را وارد کنید..." style="border-radius: 12px; padding: 16px; font-size: 16px; resize: vertical; min-height: 150px;"></textarea>
                        </div>
                        {% comment %} <div class="mb-3">
                            <label class="form-label fw-bold text-dark mb-3"><i class="bi bi-paperclip me-2 text-primary"></i>فایل ضمیمه (اختیاری)</label>
                            <input type="file" name="files" class="form-control" multiple style="border-radius: 12px; padding: 16px; font-size: 16px;">
                        </div> {% endcomment %}
                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5 py-3" style="border-radius: 14px; font-weight: 600;">
                                <i class="bi bi-send-fill me-2"></i>ارسال پاسخ
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    body { background-color: #f8fafc; padding-top: 40px; line-height: 1.6; }
    .container { margin-top: 60px !important; }
    .card { border: none; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 3rem; }
    .badge { font-weight: 500; border-radius: 10px; padding: 10px 18px !important; }
    .form-control { border: 2px solid #eef2f7; transition: all 0.3s ease; font-size: 16px; }
    .form-control:focus { border-color: #1e88e5; box-shadow: 0 0 0 0.3rem rgba(30,136,229,0.2); }
    .btn-primary { background: linear-gradient(135deg,#1e88e5,#1565c0); border: none; transition: all 0.3s ease; padding: 14px 30px; font-size: 17px; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(30,136,229,0.4); }
    .btn-outline-secondary { border-radius: 12px; padding: 10px 20px; font-size: 15px; }
    .card-body { padding: 1.5rem !important; }
    .mb-4 { margin-bottom: 1.5rem !important; }
    .mb-5 { margin-bottom: 2rem !important; }
    .mt-3 { margin-top: 1rem !important; }
    .mt-4 { margin-top: 1.5rem !important; }
    .py-4 { padding-top: 1.5rem !important; padding-bottom: 1.5rem !important; }
    .py-5 { padding-top: 2rem !important; padding-bottom: 2rem !important; }
    .p-5 { padding: 2rem !important; }

    /* فاصله بین فایل‌ها */
    .attachment-link { display: inline-block; margin: 8px; }

    /* فاصله بین کارت‌ها */
    .card + .card { margin-top: 2rem; }

    /* تصویر فایل */
    .attachment-link img { max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover; }

    /* فایل‌های دانلودی */
    .attachment-link i { margin-right: 5px; }

    /* برای responsive بودن تصاویر */
    @media (max-width: 576px) {
        .attachment-link img { max-width: 100px; max-height: 100px; }
    }
</style>

{% endblock content %}
