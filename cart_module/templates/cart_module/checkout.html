{% extends "base.html" %}
{% load static %}
{% load custom_filters %}


{% block page_title %}
تسویه حساب
{% endblock page_title %}

{% block content %}

<section class="breadcrumb py-120 bg-main-25 position-relative z-1 overflow-hidden mb-0">
    <img src="{% static "images/shapes/shape1.png" %}" alt="" class="shape one animation-rotation d-md-block d-none">
    <img src="{% static "images/shapes/shape2.png" %}" alt="" class="shape two animation-scalation d-md-block d-none">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="breadcrumb__wrapper">
                    <h1 class="breadcrumb__title display-4 fw-semibold text-center">تسویه حساب</h1>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="py-120">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="border border-neutral-30 rounded-12 bg-main-25 p-32 mt-24">
                    <h4 class="mb-12">روش پرداخت</h4>
                    <div class="d-flex align-items-center gap-24 flex-wrap">
                        <div class="form-check common-check common-radio mb-0">
                            <input class="form-check-input" type="radio" name="card" id="creditCard">
                            <label class="form-check-label fw-normal flex-grow-1" for="creditCard">کارت اعتباری</label>
                        </div>
                        <div class="form-check common-check common-radio mb-0">
                            <input class="form-check-input" type="radio" name="card" id="Debitcard">
                            <label class="form-check-label fw-normal flex-grow-1" for="Debitcard">دبیت کارت</label>
                        </div>
                        <div class="form-check common-check common-radio mb-0">
                            <input class="form-check-input" type="radio" name="card" id="PayPal">
                            <label class="form-check-label fw-normal flex-grow-1" for="PayPal">پی پال</label>
                        </div>
                    </div>
                    <span class="d-block border border-neutral-30 my-24 border-dashed"></span>
                    <div class="row gy-4">
                        <div class="col-sm-12">
                            <label for="cardNumber" class="text-neutral-700 text-lg fw-medium mb-12">شماره کارت</label>
                            <input type="text" class="common-input bg-white rounded-pill border-neutral-40" id="cardNumber" placeholder="۶۱۰۴ ۳۳۸۹ ۹۴۰۷ ۶۶۶۶">
                        </div>
                        <div class="col-sm-6 col-xs-6">
                            <label for="Expirydate" class="text-neutral-700 text-lg fw-medium mb-12">تاریخ انقضا</label>
                            <input type="date" class="common-input bg-white rounded-pill border-neutral-40" id="Expirydate">
                        </div>
                        <div class="col-sm-6 col-xs-6">
                            <label for="cvv" class="text-neutral-700 text-lg fw-medium mb-12">CVC / CVV</label>
                            <input type="text" class="common-input bg-white rounded-pill border-neutral-40" id="cvv" placeholder="۳ رقم">
                        </div>
                        <div class="col-sm-12">
                            <label for="nameCard" class="text-neutral-700 text-lg fw-medium mb-12">نام روی کارت</label>
                            <input type="text" class="common-input bg-white rounded-pill border-neutral-40" id="nameCard" placeholder="محمد حسن فرهادی">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="border border-neutral-30 rounded-12 bg-main-25 p-24">
                <span class="text-neutral-700 text-lg mb-12">قیمت</span>
                    <div class="flex-align align-items-start flex-wrap gap-8">
                        <div class="flex-align gap-12 text-neutral-700">
                            <span class="text-2xl d-flex"><i class="ph-bold ph-tag"></i></span>
                            <h2 class="mb-0"> {{ order.total_price|smart_price }} تومان </h2>
                        </div>
                        <button type="button" class="text-neutral-500 text-sm" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Initial Price">
                            <i class="ph-bold ph-info"></i>
                        </button>
                    </div>
                    <br>
                    {% if order.discount %}
                        <p>تخفیف اعمال شده: {{ order.discount.amount }} تومان</p>
                    {% endif %}

                    <span class="d-block border border-neutral-30 my-24 border-dashed"></span>

                    <form id="discountForm" method="post" action="{% url 'cart_module:apply_discount' order.id %}">
                        {% csrf_token %}
                        <input type="text" name="code" placeholder="کد تخفیف" class="common-input w-100 mb-2">
                        <br>
                        <button type="submit" class="btn btn-secondary w-100">اعمال کد تخفیف</button>
                    </form>

                    <span class="d-block border border-neutral-30 my-24 border-dashed"></span>

                    <!-- فرم پرداخت جدا -->
                    <form method="post" action="{% url 'cart_module:checkout' order.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-main rounded-pill w-100 mt-2">پرداخت</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS برای POST فرم کد تخفیف -->
<script>
document.getElementById('discountForm').addEventListener('submit', function(e) {
    e.preventDefault(); // جلوگیری از رفتار پیش‌فرض

    const form = e.target;
    const url = form.action;
    const formData = new FormData(form);

    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url; // ریدایرکت پس از اعمال تخفیف
        } else {
            window.location.reload(); // اگر بدون redirect
        }
    })
    .catch(error => console.error('Error:', error));
});
</script>

{% endblock content %}
